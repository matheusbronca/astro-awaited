---
interface Props {
  transitionDuration?: number,
  transitionEase?: "linear" | "ease-in" | "ease-out" | "ease-in-out";
  contentProps?: Record<string, unknown>
}

const { transitionDuration = 250, transitionEase = 'linear', contentProps, ...rest  } = Astro.props

---
<div data-awaited-wrapper {...rest} >
  <slot name="fallback" />
  <div data-awaited-content {...contentProps} >
    <slot />
  </div>
</div>
<script is:inline>
    const cleanupAwaitedContent = (e) => {
      if(e.from.pathname !== e.to.pathname) return;
      const awaitedContents = document.querySelectorAll('[data-awaited-content]');
      awaitedContents.forEach(el => el.remove());
    };

    const handleAwaitedOnTransition = () => {
      document.addEventListener('astro:before-preparation', cleanupAwaitedContent)
    }

    // Ensure that the event will be added only once
    document.addEventListener("astro:page-load", handleAwaitedOnTransition, { once: true })
</script>

<style define:vars={{ animationDuration: `${transitionDuration}ms`, animationEase: transitionEase }}>
  [data-awaited-wrapper] {
    position: relative; 
  }

  :global([data-awaited-fallback])  {
    pointer-events: none;
    opacity: 1;
  }

  [data-awaited-wrapper]:has([data-awaited-content] > *:not(:empty)) > :global([data-awaited-fallback]) {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      opacity: 0;
      transition: all var(--animationDuration) var(--animationEase);
  }
</style>
